import{R as e,T as t,j as s,d as n,c as i,m as a,a as r,r as o,b as c,e as l,f as d,p as h,i as m,t as u,u as p,g as f,h as x,k as g,l as y,n as w,o as j,q as v,s as N,v as b,w as S,x as k,y as _,z as C,A as M,B as I,C as E,D as T,E as O,F as U,G as R,H as z,I as $,J as D}from"./ui-vendor-D6d1Ui2K.js";import{a as L,g as P}from"./react-vendor-DEQ385Nk.js";import{I as q}from"./icons-vendor-B_HZPVPc.js";import"./utils-vendor-DAKAqO7Y.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var A,W={};const H=P(function(){if(A)return W;A=1;var e=L();return W.createRoot=e.createRoot,W.hydrateRoot=e.hydrateRoot,W}());e.forwardRef(({children:o,className:c,onOpenChange:l,isOpen:d,sidebarWidth:h=288,classNames:m={},sidebarPlacement:u="left",motionProps:p,...f},x)=>{const g=e.useMemo(()=>p&&"object"==typeof p?p:{variants:{enter:{x:0,transition:{x:{duration:.3,ease:t.easeOut}}},exit:{x:"left"==u?-h:h,transition:{x:{duration:.2,ease:t.easeOut}}}}},[h,u,p]);return s.jsxs(s.Fragment,{children:[s.jsx(n,{ref:x,...f,classNames:{...m,wrapper:i("!w-[var(--sidebar-width)]",m?.wrapper,{"!items-start !justify-start ":"left"===u,"!items-end !justify-end":"right"===u}),base:i("w-[var(--sidebar-width)] !m-0 p-0 h-full max-h-full",m?.base,c,{"inset-y-0 left-0 max-h-[none] rounded-l-none !justify-start":"left"===u,"inset-y-0 right-0 max-h-[none] rounded-r-none !justify-end":"right"===u}),body:i("p-0",m?.body),closeButton:i("z-50",m?.closeButton)},isOpen:d,motionProps:g,radius:"none",scrollBehavior:"inside",style:{"--sidebar-width":`${h}px`},onOpenChange:l,children:s.jsx(a,{children:s.jsx(r,{children:o})})}),s.jsx("div",{className:i("hidden h-full max-w-[var(--sidebar-width)] overflow-x-hidden overflow-y-scroll sm:flex",c),children:o})]})}).displayName="SidebarDrawer";const F="text",B="image",J="file",Q="voice",V="system",G=e.forwardRef(({avatar:t,name:n,time:a,message:r,messageType:u=F,isRTL:p,imageUrl:f,fileName:x,fileSize:g,fileUrl:y,voiceDuration:w,voiceUrl:j,status:v,className:N,classNames:b,...S},k)=>{const _=e.useRef(null),C=o.useCallback(()=>s.jsx("div",{className:"relative flex-none",children:s.jsx(c,{src:t})}),[t]),[M,I]=e.useState(!1),E=e=>{if(!e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},T=()=>{switch(u){case F:return s.jsx("div",{className:"whitespace-pre-line",children:r});case B:return s.jsx("div",{className:"mt-2",children:s.jsx(m,{alt:`Image sent by ${n}`,className:"rounded-lg cursor-pointer hover:opacity-90 transition-opacity",src:f,width:264,onClick:()=>window.open(f,"_blank")})});case J:return s.jsx("div",{className:"mt-2",children:s.jsx(d,{className:"w-full justify-start",variant:"flat",startContent:s.jsx(q,{icon:"solar:document-linear",width:20}),endContent:s.jsx(q,{icon:"solar:download-linear",width:16}),onClick:()=>window.open(y,"_blank"),children:s.jsxs("div",{className:"flex flex-col items-start",children:[s.jsx("span",{className:"text-small font-medium",children:x}),s.jsx("span",{className:"text-tiny text-default-400",children:E(g)})]})})});case Q:return s.jsx("div",{className:"mt-2",children:s.jsx(d,{className:"w-full justify-start",variant:"flat",startContent:s.jsx(q,{icon:M?"solar:pause-circle-linear":"solar:play-circle-linear",width:24}),onClick:()=>{I(!M)},children:s.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[s.jsx("div",{className:"flex-1",children:s.jsx(h,{size:"sm",value:M?50:0,className:"max-w-md",color:"primary"})}),s.jsx("span",{className:"text-tiny text-default-400",children:(e=w||0,`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`)})]})})});case V:return s.jsx("div",{className:"text-center text-tiny text-default-400 py-2",children:r});default:return s.jsx("div",{className:"whitespace-pre-line",children:r})}var e},O=()=>u===V?s.jsx("div",{className:"flex justify-center w-full",children:s.jsx(l,{size:"sm",variant:"flat",className:"bg-default-100",children:r})}):s.jsx("div",{className:"flex max-w-[70%] flex-col gap-4",children:s.jsxs("div",{className:i("relative w-full rounded-medium bg-content2 px-4 py-3 text-default-600",b?.base),children:[s.jsxs("div",{className:"flex",children:[s.jsx("div",{className:"w-full text-small font-semibold text-default-foreground",children:n}),s.jsx("div",{className:"flex-end text-small text-default-400",children:a})]}),s.jsx("div",{ref:_,className:"mt-2 text-small text-default-900",children:T()}),v&&p&&s.jsxs("div",{className:"absolute -bottom-5 right-0 text-tiny text-default-400",children:["sent"===v&&s.jsx(q,{icon:"solar:check-circle-linear",width:16}),"delivered"===v&&s.jsx(q,{icon:"solar:check-read-linear",width:16}),"read"===v&&s.jsx(q,{icon:"solar:check-read-linear",width:16,className:"text-primary"}),"failed"===v&&s.jsx(q,{icon:"solar:close-circle-linear",width:16,className:"text-danger"})]})]})});return s.jsxs("div",{...S,ref:k,className:i("flex gap-3",{"flex-row-reverse":p},u===V&&"justify-center",N),children:[u!==V&&s.jsx(C,{}),s.jsx(O,{})]})});G.displayName="MessagingChatMessage";const K=e.forwardRef(({classNames:e={},...t},n)=>s.jsx(u,{ref:n,"aria-label":"Prompt",className:"min-h-[40px]",classNames:{...e,label:i("hidden",e?.label),input:i("py-0",e?.input)},minRows:1,placeholder:"Enter a prompt here",radius:"lg",variant:"bordered",...t}));function X({onSendMessage:e,onTyping:t,placeholder:n="输入消息...",classNames:c={},...h}){const[u,N]=o.useState(""),[b,S]=o.useState(!1),[k,_]=o.useState(0),[C,M]=o.useState([]),[I,E]=o.useState(null),T=o.useRef(null),O=o.useRef(null),U=o.useRef(null),{isOpen:R,onOpen:z,onClose:$}=p(),D=()=>{u.trim()&&(e({type:"text",content:u.trim()}),N(""))},L=async()=>{try{await navigator.mediaDevices.getUserMedia({audio:!0});S(!0),_(0),U.current=setInterval(()=>{_(e=>e+1)},1e3)}catch(e){alert("无法访问麦克风，请检查权限设置")}},P=()=>{S(!1),U.current&&(clearInterval(U.current),U.current=null),e({type:"voice",voiceDuration:k}),_(0)};return s.jsxs(s.Fragment,{children:[s.jsxs("form",{className:"flex w-full items-start gap-2",onSubmit:e=>{e.preventDefault(),D()},children:[s.jsx("input",{ref:T,type:"file",className:"hidden",onChange:t=>{const s=Array.from(t.target.files);0!==s.length&&(s.forEach(t=>{t.size>10485760?alert(`文件 ${t.name} 超过10MB限制`):e({type:"file",file:t,fileName:t.name,fileSize:t.size})}),t.target.value="")},multiple:!0}),s.jsx("input",{ref:O,type:"file",accept:"image/*",className:"hidden",onChange:e=>{const t=Array.from(e.target.files);if(0===t.length)return;const s=t[0];if(!s.type.startsWith("image/"))return void alert("请选择图片文件");if(s.size>5242880)return void alert("图片大小不能超过5MB");const n=new FileReader;n.onload=e=>{E({url:e.target.result,file:s}),z()},n.readAsDataURL(s),e.target.value=""}}),s.jsx(K,{...h,placeholder:b?"正在录音...":n,disabled:b,classNames:{innerWrapper:i("items-center",c?.innerWrapper),input:i("text-medium data-[has-start-content=true]:ps-0 data-[has-start-content=true]:pe-0",c?.input)},endContent:s.jsxs("div",{className:"flex gap-2",children:[b&&s.jsxs(l,{size:"sm",color:"danger",variant:"flat",children:[s.jsx(q,{icon:"solar:record-circle-bold",width:16,className:"animate-pulse"}),s.jsx("span",{className:"ml-1",children:(A=k,`${Math.floor(A/60)}:${(A%60).toString().padStart(2,"0")}`)})]}),!u&&!b&&s.jsx(y,{showArrow:!0,content:"按住录音",children:s.jsx(d,{isIconOnly:!0,radius:"full",variant:"light",onMouseDown:L,onMouseUp:P,onMouseLeave:P,onTouchStart:L,onTouchEnd:P,children:s.jsx(q,{className:"text-default-500",icon:"solar:microphone-3-linear",width:20})})}),b&&s.jsx(y,{showArrow:!0,content:"停止录音",children:s.jsx(d,{isIconOnly:!0,color:"danger",radius:"full",variant:"solid",onClick:P,children:s.jsx(q,{icon:"solar:stop-circle-linear",width:20})})}),!b&&s.jsx(y,{showArrow:!0,content:"发送消息",children:s.jsx(d,{isIconOnly:!0,className:h?.classNames?.button||"",color:u?"primary":"default",isDisabled:!u,radius:"full",variant:u?"solid":"flat",onClick:D,children:s.jsx(q,{className:i("[&>path]:stroke-[2px]",u?"text-primary-foreground":"text-default-500",h?.classNames?.buttonIcon||""),icon:"solar:arrow-up-linear",width:20})})})]}),startContent:s.jsxs(f,{placement:"top",children:[s.jsx(x,{children:s.jsx(d,{isIconOnly:!0,className:"p-[10px]",radius:"full",variant:"light",children:s.jsx(q,{className:"text-default-500",icon:"solar:paperclip-linear",width:20})})}),s.jsx(g,{className:"p-1",children:s.jsxs("div",{className:"flex flex-col",children:[s.jsx(d,{className:"justify-start",variant:"light",startContent:s.jsx(q,{icon:"solar:gallery-linear",width:20}),onClick:()=>O.current?.click(),children:"发送图片"}),s.jsx(d,{className:"justify-start",variant:"light",startContent:s.jsx(q,{icon:"solar:document-linear",width:20}),onClick:()=>T.current?.click(),children:"发送文件"})]})})]}),value:u,onValueChange:e=>{N(e),t&&t()}})]}),s.jsx(w,{isOpen:R,onClose:$,size:"lg",children:s.jsxs(a,{children:[s.jsx(j,{children:"发送图片"}),s.jsx(r,{children:I&&s.jsx(m,{alt:"Preview",src:I.url,className:"w-full h-auto max-h-[400px] object-contain"})}),s.jsxs(v,{children:[s.jsx(d,{variant:"flat",onPress:$,children:"取消"}),s.jsx(d,{color:"primary",onPress:()=>{I&&(e({type:"image",file:I.file,imageUrl:I.url}),E(null),$())},children:"发送"})]})]})})]});var A}K.displayName="PromptInput";const Y={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var Z={};const ee=new class{constructor(){this.connectionPool=new Map,this.primaryConnection=null,this.backupConnections=[],this.eventListeners=new Map,this.realtimeStatusCallbacks=[],this.config=null,this.connectionId=this.generateConnectionId(),this.sessionToken=this.generateSessionToken(),this.networkMetrics={latency:0,jitter:0,throughput:0,reliability:100,packet_loss:0,connection_stability:100,error_rate:0,signal_strength:100},this.performanceStats={messages_sent:0,messages_received:0,messages_confirmed:0,connection_switches:0,total_uptime:0,last_status_update:0,avg_notification_delay:0,fastest_notification:1/0,slowest_notification:0},this.pendingConfirmations=new Map,this.messageQueue=[],this.criticalMessageQueue=[],this.reconnectConfig={base_delay:100,max_delay:5e3,max_attempts:50,backoff_factor:1.2,health_check_interval:2e3,connection_timeout:8e3},this.reconnectAttempts=0,this.isIntentionalClose=!1,this.connectionStartTime=0,this.healthCheckTimer=null,this.metricsUpdateTimer=null,this.reconnectTimer=null,this.performanceTimer=null,this.initializePerformanceMonitoring(),this.setupNetworkEventListeners()}async connect(e){return new Promise((t,s)=>{try{this.config={...e,priority:e.priority||"high",quality:e.quality||"high_performance",pool_size:e.pool_size||3,dedicated_channel:e.dedicated_channel||!0,sessionToken:e.sessionToken||null},this.establishPrimaryConnection(t,s),this.config.pool_size>1&&setTimeout(()=>this.establishBackupConnections(),100),this.startPerformanceMonitoring()}catch(n){s(n)}})}establishPrimaryConnection(e,t){if(!this.config)return void t(new Error("配置未初始化"));const s=this.buildOptimizedWebSocketUrl(this.config);this.connectionStartTime=performance.now(),this.primaryConnection=new WebSocket(s),this.primaryConnection.onopen=t=>{const s=performance.now()-this.connectionStartTime;this.reconnectAttempts=0,this.networkMetrics.latency=s,this.networkMetrics.connection_stability=100,this.registerConnection("primary",this.primaryConnection),this.sendEnterpriseHandshake(),this.startHealthCheck(),this.emit("connected",{connectionId:this.connectionId,type:"primary",metrics:this.networkMetrics}),e()},this.primaryConnection.onmessage=e=>{const t=performance.now();this.handleRealtimeMessage(e.data,t)},this.primaryConnection.onclose=e=>{this.handleConnectionClose("primary",e)},this.primaryConnection.onerror=e=>{this.networkMetrics.error_rate++,this.handleConnectionError("primary",e),0===this.reconnectAttempts&&t(new Error("主连接建立失败"))},setTimeout(()=>{this.primaryConnection?.readyState!==WebSocket.OPEN&&(this.primaryConnection?.close(),t(new Error("连接超时")))},this.reconnectConfig.connection_timeout)}handleRealtimeMessage(e,t){try{this.performanceStats.messages_received++;const s=JSON.parse(e),n=performance.now();this.isStatusUpdateMessage(s)&&this.processStatusUpdateInstantly(s,t),this.processGeneralMessage(s);const i=performance.now()-n;this.updateNotificationDelay(i),this.updateNetworkQuality(t)}catch(s){this.networkMetrics.error_rate++}}processStatusUpdateInstantly(e,t){const s={event_type:this.determineEventType(e),user_id:e.user_id,user_data:e.user_data||e.user_info,users_data:e.users,timestamp:t,latency:t-(e.sent_at||t),priority:this.determinePriority(e)};this.realtimeStatusCallbacks.forEach(e=>{try{e(s)}catch(t){}});const n=performance.now()-t;n<this.performanceStats.fastest_notification&&(this.performanceStats.fastest_notification=n)}onRealtimeStatusChange(e){this.realtimeStatusCallbacks.push(e)}offRealtimeStatusChange(e){const t=this.realtimeStatusCallbacks.indexOf(e);t>-1&&this.realtimeStatusCallbacks.splice(t,1)}sendCriticalMessage(e,t="chat"){const s=this.generateMessageId(),n={id:s,type:t,content:e,from:this.config?.user_name||"unknown",timestamp:(new Date).toISOString()};return this.criticalMessageQueue.push(n),this.sendMessageInstantly(n),this.setupMessageConfirmation(s,"critical"),s}sendMessageInstantly(e){if(!this.primaryConnection||this.primaryConnection.readyState!==WebSocket.OPEN)return this.sendViaBackupConnection(e);try{const t=JSON.stringify(e);return this.primaryConnection.send(t),this.performanceStats.messages_sent++,!0}catch(t){return this.sendViaBackupConnection(e)}}sendViaBackupConnection(e){for(const s of this.backupConnections)if(s.readyState===WebSocket.OPEN)try{return s.send(JSON.stringify(e)),this.performanceStats.connection_switches++,!0}catch(t){}return this.messageQueue.push(e),!1}requestOnlineUsersInstantly(){this.sendCriticalMessage(JSON.stringify({type:"request_online_users",timestamp:Date.now(),priority:"high"}),"system")}getPerformanceMetrics(){return{network:{...this.networkMetrics},performance:{...this.performanceStats},connection:{primary_status:this.primaryConnection?.readyState===WebSocket.OPEN?"active":"inactive",backup_count:this.backupConnections.filter(e=>e.readyState===WebSocket.OPEN).length,pool_size:this.connectionPool.size,uptime:this.connectionStartTime?performance.now()-this.connectionStartTime:0}}}generateConnectionId(){return`ent_conn_${Date.now()}_${Math.random().toString(36).substr(2,12)}`}generateSessionToken(){return`ent_session_${Date.now()}_${Math.random().toString(36).substr(2,16)}`}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,8)}`}buildOptimizedWebSocketUrl(e){const t=this.getEnvironmentVariable("REACT_APP_WS_URL")||"ws://localhost:6006/ws",s=new URLSearchParams({user_id:encodeURIComponent(e.user_id||e.user_name),user_name:encodeURIComponent(e.user_name),user_type:e.user_type||"kefu",connection_id:this.connectionId,priority:e.priority||"high",quality:e.quality||"high_performance",session:this.sessionToken,session_id:`session_${Date.now()}`,timestamp:(new Date).toISOString()});return e.sessionToken&&s.set("session_token",e.sessionToken),e.kefu_id&&s.set("kefu_id",e.kefu_id),`${t}?${s.toString()}`}getEnvironmentVariable(e){try{if(import.meta&&Y)return Y[e]}catch(t){}return"undefined"!=typeof process&&Z?Z[e]:"undefined"!=typeof window&&window.env?window.env[e]:null}isStatusUpdateMessage(e){return"UserJoined"===e.type||"user_joined"===e.type||"UserLeft"===e.type||"user_left"===e.type||"Status"===e.type||"status_change"===e.type||"OnlineUsers"===e.type||"online_users"===e.type||"online"===e.action||"offline"===e.action||"online_users_update"===e.action}determineEventType(e){return"UserJoined"===e.type||"user_joined"===e.type||"online"===e.action?"user_online":"UserLeft"===e.type||"user_left"===e.type||"offline"===e.action?"user_offline":"OnlineUsers"===e.type||"online_users"===e.type||"online_users_update"===e.action?"bulk_update":(e.type,"user_status_change")}determinePriority(e){return e.priority?e.priority:"UserJoined"===e.type||"user_joined"===e.type||"UserLeft"===e.type||"user_left"===e.type||"online"===e.action||"offline"===e.action?"high":"normal"}processGeneralMessage(e){Object.keys(this.eventListeners).forEach(t=>{e.type!==t&&e.action!==t||this.eventListeners.get(t)?.forEach(t=>{try{t(e)}catch(s){}})})}updateNotificationDelay(e){this.performanceStats.avg_notification_delay=(this.performanceStats.avg_notification_delay+e)/2,e>this.performanceStats.slowest_notification&&(this.performanceStats.slowest_notification=e)}updateNetworkQuality(e){const t=performance.now()-e;this.networkMetrics.latency=(this.networkMetrics.latency+t)/2,this.networkMetrics.jitter=Math.abs(this.networkMetrics.latency-t);const s=this.performanceStats.messages_received/Math.max(this.performanceStats.messages_sent,1);this.networkMetrics.reliability=Math.min(100,100*s)}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const s=this.eventListeners.get(e);if(s){const e=s.indexOf(t);e>-1&&s.splice(e,1)}}emit(e,t){this.eventListeners.get(e)?.forEach(e=>{try{e(t)}catch(s){}})}isConnected(){return this.primaryConnection?.readyState===WebSocket.OPEN}sendMessage(e){this.sendCriticalMessage(e,"chat")}sendChatMessage(e,t,s){const n={id:this.generateMessageId(),type:"chat",content:e,from:this.config?.user_name||"unknown",timestamp:(new Date).toISOString(),content_type:t,filename:s};this.sendMessageInstantly(n)}requestOnlineUsers(){this.requestOnlineUsersInstantly()}sendTypingIndicator(e){this.sendCriticalMessage(JSON.stringify({type:"typing",is_typing:e,timestamp:Date.now()}),"typing")}establishBackupConnections(){}registerConnection(e,t){this.connectionPool.set(e,t)}sendEnterpriseHandshake(){}startHealthCheck(){this.healthCheckTimer=setInterval(()=>{this.isConnected()&&this.sendCriticalMessage("ping","heartbeat")},this.reconnectConfig.health_check_interval)}handleConnectionClose(e,t){this.isIntentionalClose||this.attemptReconnection()}handleConnectionError(e,t){this.networkMetrics.error_rate++}attemptReconnection(){if(this.reconnectAttempts>=this.reconnectConfig.max_attempts)return;this.reconnectAttempts++;const e=Math.min(this.reconnectConfig.base_delay*Math.pow(this.reconnectConfig.backoff_factor,this.reconnectAttempts),this.reconnectConfig.max_delay);this.reconnectTimer=setTimeout(()=>{this.connect(this.config).catch(e=>{this.attemptReconnection()})},e)}initializePerformanceMonitoring(){}setupNetworkEventListeners(){"undefined"!=typeof navigator&&"onLine"in navigator&&(window.addEventListener("online",()=>{this.isConnected()||this.attemptReconnection()}),window.addEventListener("offline",()=>{}))}startPerformanceMonitoring(){this.performanceTimer=setInterval(()=>{this.getPerformanceMetrics()},1e4)}setupMessageConfirmation(e,t){const s={message_id:e,sent_at:Date.now(),retry_count:0,priority:t,ttl:3e4};this.pendingConfirmations.set(e,s),setTimeout(()=>{const t=this.pendingConfirmations.get(e);t&&!t.confirmed_at&&this.pendingConfirmations.delete(e)},s.ttl)}destroy(){this.isIntentionalClose=!0,this.healthCheckTimer&&clearInterval(this.healthCheckTimer),this.metricsUpdateTimer&&clearInterval(this.metricsUpdateTimer),this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.performanceTimer&&clearInterval(this.performanceTimer),this.primaryConnection?.close(),this.backupConnections.forEach(e=>e.close()),this.connectionPool.forEach(e=>e.close()),this.eventListeners.clear(),this.realtimeStatusCallbacks.length=0,this.messageQueue.length=0,this.criticalMessageQueue.length=0,this.pendingConfirmations.clear()}};class te{constructor(e,t={}){this.baseUrl=e,this.ws=null,this.reconnectInterval=t.reconnectInterval||5e3,this.maxReconnectAttempts=t.maxReconnectAttempts||5,this.reconnectAttempts=0,this.isConnecting=!1,this.handlers=new Map,this.messageQueue=[],this.heartbeatInterval=null,this.userId=t.userId,this.userType=t.userType||"kefu",this.sessionToken=t.sessionToken,this.enableEnterpriseFeatures=!1!==t.enableEnterpriseFeatures,this.enterpriseManager=null,this.performanceMetrics={messagesReceived:0,messagesSent:0,reconnectCount:0,avgResponseTime:0,lastHeartbeat:null},this.enableEnterpriseFeatures&&this.initializeEnterpriseFeatures()}initializeEnterpriseFeatures(){this.enterpriseManager=ee,this.enterpriseManager.onRealtimeStatusChange(e=>{this.emit("realtime_status_change",e)})}connect(){if(!(this.isConnecting||this.ws&&this.ws.readyState===WebSocket.OPEN)){if(this.enableEnterpriseFeatures&&this.enterpriseManager)return this.connectWithEnterpriseFeatures();this.isConnecting=!0,this.performanceMetrics.reconnectCount++;try{const e=new URLSearchParams({user_id:this.userId,user_type:this.userType,user_name:this.userId,session_id:`session_${Date.now()}`,timestamp:(new Date).toISOString()});"kefu"===this.userType&&this.sessionToken&&e.set("session_token",this.sessionToken);const t=`${this.baseUrl}?${e.toString()}`;this.ws=new WebSocket(t),this.ws.onopen=()=>{this.isConnecting=!1,this.reconnectAttempts=0,this.flushMessageQueue(),this.startHeartbeat(),this.emit("connected")},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.performanceMetrics.messagesReceived++,this.handleMessage(t)}catch(t){}},this.ws.onerror=e=>{this.emit("error",e)},this.ws.onclose=()=>{this.isConnecting=!1,this.stopHeartbeat(),this.emit("disconnected"),this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,setTimeout(()=>this.connect(),this.reconnectInterval))}}catch(e){this.isConnecting=!1}}}disconnect(){this.ws&&(this.reconnectAttempts=this.maxReconnectAttempts,this.ws.close(),this.ws=null),this.stopHeartbeat()}async connectWithEnterpriseFeatures(){try{return await this.enterpriseManager.connect({user_id:this.userId,user_name:this.userId,user_type:this.userType,priority:"high",quality:"high_performance",sessionToken:this.sessionToken}),this.enterpriseManager.on("message",e=>{this.performanceMetrics.messagesReceived++,this.handleMessage(e)}),this.enterpriseManager.on("connected",()=>{this.isConnecting=!1,this.reconnectAttempts=0,this.emit("connected")}),this.enterpriseManager.on("disconnected",()=>{this.emit("disconnected")}),this.enterpriseManager.on("error",e=>{this.emit("error",e)}),!0}catch(e){return this.enableEnterpriseFeatures=!1,this.connect()}}send(e){if(this.enableEnterpriseFeatures&&this.enterpriseManager?.isConnected())return this.enterpriseManager.sendMessage(JSON.stringify(e)),void this.performanceMetrics.messagesSent++;this.ws&&this.ws.readyState===WebSocket.OPEN?(this.ws.send(JSON.stringify(e)),this.performanceMetrics.messagesSent++):this.messageQueue.push(e)}sendMessage(e){let t=e.messageType||e.content_type||"text";t=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();const s={type:"Chat",id:Date.now().toString(),from:this.userId,to:e.receiverId||e.to,content:e.content,content_type:t,timestamp:(new Date).toISOString(),...e};return delete s.messageType,this.send(s),s}async sendFile(e,t="file"){const s=new FormData;s.append("file",e),s.append("type",t);try{const n=await fetch("/api/file/upload",{method:"POST",body:s});if(!n.ok)throw new Error("文件上传失败");const i=await n.json(),a={content:i.url,content_type:t,fileUrl:i.url,fileName:e.name,fileSize:e.size,thumbnailUrl:i.thumbnailUrl};return this.sendMessage(a)}catch(n){throw n}}sendTyping(e,t=!0){this.send({type:"Typing",from_user_id:this.userId,to_user_id:e,is_typing:t,timestamp:(new Date).toISOString()})}handleMessage(e){const{type:t}=e;if("Chat"===t){const t={id:e.id,messageType:e.content_type?.toLowerCase()||"text",content:e.content,senderId:e.from,senderName:e.from,receiverId:e.to,timestamp:e.timestamp,fileName:e.filename,fileUrl:e.url,...e};this.emit("Chat",t)}else this.emit(t,e);this.emit("message",e)}on(e,t){this.handlers.has(e)||this.handlers.set(e,[]),this.handlers.get(e).push(t)}off(e,t){if(this.handlers.has(e)){const s=this.handlers.get(e),n=s.indexOf(t);n>-1&&s.splice(n,1)}}emit(e,t){this.handlers.has(e)&&this.handlers.get(e).forEach(e=>{try{e(t)}catch(s){}})}flushMessageQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();this.send(e)}}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{this.send({type:"Heartbeat",user_id:this.userId,timestamp:(new Date).toISOString()})},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}get isConnected(){return this.ws&&this.ws.readyState===WebSocket.OPEN}get connectionState(){if(this.enableEnterpriseFeatures&&this.enterpriseManager)return this.enterpriseManager.isConnected()?"connected":"disconnected";if(!this.ws)return"disconnected";switch(this.ws.readyState){case WebSocket.CONNECTING:return"connecting";case WebSocket.OPEN:return"connected";case WebSocket.CLOSING:return"closing";case WebSocket.CLOSED:return"closed";default:return"unknown"}}getPerformanceMetrics(){const e={...this.performanceMetrics};if(this.enableEnterpriseFeatures&&this.enterpriseManager){const t=this.enterpriseManager.getPerformanceMetrics();return{...e,enterprise:t,connectionType:"enterprise"}}return{...e,connectionType:"standard"}}requestOnlineUsers(){this.enableEnterpriseFeatures&&this.enterpriseManager?this.enterpriseManager.requestOnlineUsersInstantly():this.send({type:"GetOnlineUsers",user_id:this.userId,timestamp:(new Date).toISOString()})}}let se=null;function ne({onLoginSuccess:t}){const[n,i]=e.useState(!1),[a,r]=e.useState(""),[o,h]=e.useState(""),[m,u]=e.useState(!1),[p,f]=e.useState(!1),[x,g]=e.useState("");return e.useEffect(()=>{if("true"===localStorage.getItem("kefu_remember")){const t=localStorage.getItem("kefu_user");if(t)try{const e=JSON.parse(t);r(e.username||""),u(!0)}catch(e){}}},[]),s.jsx("div",{className:"flex h-full w-full items-center justify-center bg-gradient-to-br from-default-100 via-primary-100 to-secondary-100",children:s.jsxs(N,{className:"w-full max-w-sm shadow-2xl",children:[s.jsx(b,{className:"flex flex-col gap-1 px-8 pt-6",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-primary",children:s.jsx(q,{icon:"solar:chat-round-line-duotone",className:"text-white",width:24})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl font-bold",children:"客服系统登录"}),s.jsx("p",{className:"text-small text-default-500",children:"企业级客服管理平台"})]})]})}),s.jsxs(S,{className:"px-8 py-6",children:[s.jsxs("form",{className:"flex flex-col gap-4",onSubmit:async e=>{e.preventDefault(),g(""),f(!0);try{const e="http://localhost:6006",s=await fetch(`${e}/api/kefu/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a,password:o})}),n=await s.json();if(n.success){const e={id:n.kefu_id,name:n.real_name,username:a,type:"kefu",sessionToken:n.session_token,maxCustomers:n.max_customers};m?(localStorage.setItem("kefu_user",JSON.stringify(e)),localStorage.setItem("kefu_session_token",n.session_token),localStorage.setItem("kefu_remember","true")):(sessionStorage.setItem("kefu_user",JSON.stringify(e)),sessionStorage.setItem("kefu_session_token",n.session_token)),t&&t(e)}else g(n.message||"登录失败")}catch(s){g("网络错误，请稍后重试")}finally{f(!1)}},children:[s.jsx(k,{isRequired:!0,label:"账号",name:"username",placeholder:"请输入客服账号",type:"text",variant:"bordered",value:a,onChange:e=>r(e.target.value),startContent:s.jsx(q,{icon:"solar:user-linear",className:"text-default-400",width:20}),isInvalid:!!x&&!a,errorMessage:!a&&x?"请输入账号":""}),s.jsx(k,{isRequired:!0,label:"密码",name:"password",placeholder:"请输入密码",type:n?"text":"password",variant:"bordered",value:o,onChange:e=>h(e.target.value),startContent:s.jsx(q,{icon:"solar:lock-password-linear",className:"text-default-400",width:20}),endContent:s.jsx("button",{className:"focus:outline-none",type:"button",onClick:()=>i(!n),"aria-label":"toggle password visibility",children:n?s.jsx(q,{className:"pointer-events-none text-2xl text-default-400",icon:"solar:eye-closed-linear"}):s.jsx(q,{className:"pointer-events-none text-2xl text-default-400",icon:"solar:eye-bold"})}),isInvalid:!!x&&!o,errorMessage:!o&&x?"请输入密码":""}),s.jsxs("div",{className:"flex w-full items-center justify-between px-1",children:[s.jsx(_,{name:"remember",size:"sm",isSelected:m,onValueChange:u,children:"记住我"}),s.jsx(C,{className:"text-default-500",href:"#",size:"sm",children:"忘记密码？"})]}),x&&s.jsx(l,{color:"danger",variant:"flat",className:"w-full",children:s.jsx("span",{className:"text-small",children:x})}),s.jsx(d,{className:"w-full",color:"primary",type:"submit",isLoading:p,startContent:!p&&s.jsx(q,{icon:"solar:login-3-linear",width:20}),children:p?"登录中...":"登录"})]}),s.jsxs("div",{className:"flex items-center gap-4 py-4",children:[s.jsx(M,{className:"flex-1"}),s.jsx("p",{className:"shrink-0 text-tiny text-default-500",children:"快速登录"}),s.jsx(M,{className:"flex-1"})]}),s.jsx("div",{className:"flex flex-col gap-2",children:[{username:"kefu001",password:"123456",name:"客服小王"},{username:"kefu002",password:"123456",name:"客服小李"}].map((e,t)=>s.jsx(d,{variant:"flat",size:"sm",startContent:s.jsx(c,{size:"sm",name:e.name,className:"w-5 h-5"}),onClick:()=>(e=>{r(e.username),h(e.password),g("")})(e),className:"justify-start",children:s.jsxs("div",{className:"flex flex-col items-start",children:[s.jsx("span",{className:"text-small",children:e.name}),s.jsx("span",{className:"text-tiny text-default-400",children:e.username})]})},t))})]}),s.jsx(I,{className:"px-8 pb-6",children:s.jsxs("div",{className:"flex flex-col w-full gap-2",children:[s.jsx("p",{className:"text-center text-tiny text-default-400",children:"版本 v1.0.0 | © 2025 企业级客服系统"}),s.jsxs("div",{className:"flex justify-center gap-2",children:[s.jsx(C,{href:"#",size:"sm",className:"text-default-400",children:"使用帮助"}),s.jsx("span",{className:"text-default-300",children:"|"}),s.jsx(C,{href:"#",size:"sm",className:"text-default-400",children:"联系管理员"})]})]})})]})})}const ie=(e,t,s)=>{try{performance.measure(e,t,s);return performance.getEntriesByName(e)[0].duration}catch(n){return null}},ae=()=>{if("memory"in performance){performance.memory}},re=e=>{if(!e)return;const t=e.send,s=e.close;e.send=function(e){performance.now();const s=`ws-send-${Date.now()}`;performance.mark(s);try{const n=t.call(this,e),i=(performance.now(),`ws-send-end-${Date.now()}`);performance.mark(i);ie("websocket-send",s,i);return n}catch(n){throw n}},e.close=function(){return s.call(this)}},oe=()=>{window.addEventListener("error",e=>{}),window.addEventListener("unhandledrejection",e=>{}),window.addEventListener("react-error",e=>{}),window.addEventListener("load",()=>{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint");e.loadEventEnd,e.loadEventStart,e.domContentLoadedEventEnd,e.domContentLoadedEventStart,t.find(e=>"first-paint"===e.name),t.find(e=>"first-contentful-paint"===e.name),(new Date).toISOString()}),(()=>{const e=window.fetch;window.fetch=async(...t)=>{performance.now();const s=`fetch-start-${Date.now()}`;performance.mark(s);try{const n=await e(...t),i=(performance.now(),`fetch-end-${Date.now()}`);return performance.mark(i),ie("fetch-request",s,i),n}catch(n){throw performance.now(),n}}})(),setInterval(ae,3e4)},ce=(e,t={})=>{const{minLength:s=0,maxLength:n=1e3,required:i=!1,pattern:a=null,trim:r=!0}=t;if("string"!=typeof e)throw new Error("输入必须是字符串");const o=r?e.trim():e;if(i&&!o)throw new Error("输入不能为空");if(o.length<s)throw new Error(`输入长度不能少于 ${s} 个字符`);if(o.length>n)throw new Error(`输入长度不能超过 ${n} 个字符`);if(a&&!a.test(o))throw new Error("输入格式不正确");return o},le=e=>{if("string"!=typeof e)return e;const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/g,e=>t[e])},de=(e,t="text")=>{switch(t){case"text":return ce(e,{required:!0,maxLength:1e3,trim:!0});case"image":return(e=>{try{return new URL(e).href}catch(t){throw new Error("无效的URL格式")}})(e);case"file":case"voice":return ce(e,{required:!0,maxLength:500});default:throw new Error(`不支持的消息类型: ${t}`)}},he=e=>((e,t={},s={})=>{const{required:n=!1,allowUnknown:i=!1}=s;if("object"!=typeof e||null===e||Array.isArray(e))throw new Error("输入必须是对象");if(n&&0===Object.keys(e).length)throw new Error("对象不能为空");const a={};for(const[o,c]of Object.entries(t))if(o in e)try{a[o]=c(e[o])}catch(r){throw new Error(`字段 ${o} 验证失败: ${r.message}`)}else if(c.required)throw new Error(`缺少必填字段 ${o}`);if(!i){const s=Object.keys(e).filter(e=>!(e in t));if(s.length>0)throw new Error(`包含未知字段: ${s.join(", ")}`)}return a})(e,{id:e=>ce(e,{required:!0,minLength:1}),name:e=>ce(e,{required:!0,minLength:1,maxLength:100}),status:e=>ce(e,{required:!0,pattern:/^(online|offline|away|busy)$/})},{allowUnknown:!0}),me={enabled:!0,minWidth:200,maxWidth:800,minHeight:100,maxHeight:600,mode:"fit",containerType:"dialog",breakpoints:{768:{fontSize:"14px",padding:"8px"},480:{fontSize:"12px",padding:"4px"}},customClasses:["adaptive-card","responsive"]},ue={fit:{description:"适应容器大小",css:{width:"100%",height:"auto",objectFit:"contain"}},scroll:{description:"滚动模式",css:{width:"100%",height:"100%",overflow:"auto"}},scale:{description:"缩放模式",css:{width:"100%",height:"100%",transform:"scale(1)",transformOrigin:"top left"}}},pe={dialog:{description:"对话框容器",css:{position:"relative",margin:"10px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)"}},modal:{description:"模态框容器",css:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1e3}},inline:{description:"内联容器",css:{display:"inline-block",verticalAlign:"top"}}};function fe(){const[t,n]=e.useState([]),[i,o]=e.useState(null),[h,m]=e.useState({}),[u,p]=e.useState(null),[f,x]=e.useState("disconnected"),[g,y]=e.useState(!1),[N,b]=e.useState(!1),[S,k]=e.useState(!1),[_,C]=e.useState(!1),[I,D]=e.useState(!1),[L,P]=e.useState(!1),[A,W]=e.useState(null),[H,K]=e.useState([]),[Y,Z]=e.useState({soundNotifications:!0,autoReply:!1,showTypingIndicator:!0,onlineStatus:!0,welcomeMessage:"您好！欢迎咨询，我是专业客服，很高兴为您服务。请问有什么可以帮助您的吗？",quickReplies:["您好！欢迎咨询，我是专业客服。","请问有什么可以帮助您的吗？","请稍候，我正在为您查询...","谢谢您的耐心等待，我会尽快处理。","如果您还有其他问题，随时可以咨询我。"]});e.useEffect(()=>{oe()},[]),e.useEffect(()=>{let e=localStorage.getItem("kefu_user"),t=localStorage.getItem("kefu_session_token");if(e&&t||(e=sessionStorage.getItem("kefu_user"),t=sessionStorage.getItem("kefu_session_token")),e&&t)try{const t=JSON.parse(e);W(t),P(!0)}catch(s){localStorage.removeItem("kefu_user"),localStorage.removeItem("kefu_session_token"),sessionStorage.removeItem("kefu_user"),sessionStorage.removeItem("kefu_session_token")}},[]),e.useEffect(()=>{const e=()=>{b(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),e.useEffect(()=>{if(!L||!A)return;let e=!0,t=null;return(async()=>{try{s="ws://localhost:6006/ws",n={userId:A?.id,userType:A?.type,sessionToken:A?.sessionToken},se&&se.ws?.readyState!==WebSocket.CLOSED||(se=new te(s,n)),t=se,t.on("connected",()=>{e&&(x("connected"),setTimeout(()=>{e&&t?.send({type:"GetOnlineUsers",user_id:A?.id,timestamp:(new Date).toISOString()})},500))}),t.on("disconnected",()=>{e&&x("disconnected")}),t.on("error",t=>{e&&x("disconnected")}),t.on("Chat",t=>{e&&ee(t)}),t.on("message",t=>{e&&ee(t)}),t.on("OnlineUsers",t=>{if(e&&t?.users){const e=t.users.filter(e=>"Kehu"===e?.user_type);ie(e)}}),t.on("UserJoined",t=>{e&&"Kehu"===t?.user_type&&ae({id:t.user_id,name:t.user_name,status:"online",lastMessage:"新客户上线",timestamp:new Date(t.timestamp),unreadCount:0,messages:[]})}),t.on("UserLeft",t=>{e&&"Kehu"===t?.user_type&&ce(t.user_id,"offline")}),t.on("Status",t=>{e&&ce(t.user_id,t.status)}),t.on("message",e=>{}),p(t),re(t)}catch(i){e&&x("error")}var s,n})(),()=>{if(e=!1,t)try{t.disconnect()}catch(s){}}},[L,A]);const ee=e=>{try{if(!e)return;const t=e?.content?de(e.content,e.messageType||"text"):"",s={id:e?.id||Date.now().toString(),type:e?.messageType||F,content:le(t),senderId:e?.senderId||"",senderName:le(e?.senderName||"未知用户"),senderAvatar:e?.senderAvatar||"",timestamp:new Date(e?.timestamp||Date.now()),imageUrl:e?.imageUrl||null,fileName:e?.fileName||null,fileSize:e?.fileSize||null,fileUrl:e?.fileUrl||null,voiceDuration:e?.voiceDuration||null,voiceUrl:e?.voiceUrl||null,status:"delivered",reactComponentData:e?.reactComponentData||null,adaptiveStyles:e?.adaptiveStyles||null};"html_template"===e?.messageType&&e?.reactComponentData&&(s.type="react_component"),n(e=>[...e,s])}catch(t){}},ie=e=>{Array.isArray(e)&&K(t=>{const s=[...t];return s.forEach(e=>{e&&(e.status="offline")}),e.forEach(e=>{const t=e?.user_id,n=e?.user_name;if(!t||!n)return;const i=s.find(e=>e?.id===t);if(i)i.status="online",i.name=n;else{const i={id:t,name:n,status:"online",avatar:e?.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=random`,lastMessage:"新客户",timestamp:new Date(e?.last_seen||Date.now()),unreadCount:0,messages:[]};s.push(i)}}),s.sort((e,t)=>e&&t?"online"===e.status&&"online"!==t.status?-1:"online"!==e.status&&"online"===t.status?1:(t.timestamp||0)-(e.timestamp||0):0)})},ae=e=>{try{if(!e?.id||!e?.name)return;const t=he(e);K(e=>{if(e.some(e=>e?.id===t.id))return e.map(e=>e?.id===t.id?{...e,status:"online",timestamp:t.timestamp}:e);var s;return[{...t,avatar:t.avatar||(s=t.name,`https://ui-avatars.com/api/?name=${encodeURIComponent(s)}&background=random`)},...e]})}catch(t){}},ce=(e,t)=>{K(s=>s.map(s=>s.id===e?{...s,status:"Online"===t?"online":"offline"}:s))},me=async e=>{if(!i)return;if(!(e?.content||e?.imageUrl||e?.fileUrl||e?.voiceUrl))return;const t={id:Date.now().toString(),type:"text"===e.type?F:"image"===e.type?B:"file"===e.type?J:"voice"===e.type?Q:F,content:e.content||"",senderId:A?.id||"",senderName:A?.name||"客服",senderAvatar:A?.avatar||"",timestamp:new Date,customerId:i.id,status:"sending",imageUrl:e.imageUrl||null,fileName:e.fileName||null,fileSize:e.fileSize||null,fileUrl:e.fileUrl||null,voiceDuration:e.voiceDuration||null,voiceUrl:e.voiceUrl||null};m(e=>({...e,[i.id]:[...e[i.id]||[],t]}));try{if(u){await u.sendMessage({messageType:e.type,content:e.content,receiverId:i.id,...e});m(e=>({...e,[i.id]:(e[i.id]||[]).map(e=>e.id===t.id?{...e,status:"sent"}:e)}))}else setTimeout(()=>{m(e=>({...e,[i.id]:(e[i.id]||[]).map(e=>e.id===t.id?{...e,status:"sent"}:e)}))},1e3)}catch(s){m(e=>({...e,[i.id]:(e[i.id]||[]).map(e=>e.id===t.id?{...e,status:"failed"}:e)}))}},ue=()=>{k(!1)},pe=(e,t)=>{Z(s=>({...s,[e]:t}))},fe=e=>{W(e),P(!0),Z(t=>({...t,welcomeMessage:`您好！欢迎咨询，我是${e.name}，很高兴为您服务。请问有什么可以帮助您的吗？`}))};return L?s.jsxs("div",{className:"h-dvh w-full flex relative",children:[N&&g&&s.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:()=>y(!1)}),s.jsxs("div",{className:`\n        ${N?"fixed left-0 top-0 h-full z-50":"relative"} \n        w-72 flex-shrink-0 border-r border-divider bg-content1 flex flex-col\n        ${N?g?"translate-x-0":"-translate-x-full":""}\n        transition-transform duration-300 ease-in-out\n      `,children:[s.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-divider",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-foreground",children:s.jsx(q,{icon:"solar:chat-round-line-duotone",className:"text-background",width:16})}),s.jsx("span",{className:"text-small font-bold",children:"客服系统"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(l,{size:"sm",variant:"dot",color:"connected"===f?"success":"default",children:"connected"===f?"已连接":"未连接"}),N&&s.jsx(d,{isIconOnly:!0,size:"sm",variant:"light",onClick:()=>y(!1),children:s.jsx(q,{icon:"solar:close-line-duotone",width:20})})]})]}),s.jsx("div",{className:"p-4 border-b border-divider",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(c,{size:"sm",src:A?.avatar,name:A?.name}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-small font-medium truncate",children:A?.name}),s.jsxs("p",{className:"text-tiny text-default-400",children:["在线 · 工号: ",A?.id]})]})]})}),s.jsxs("div",{className:"flex-1 overflow-hidden",children:[s.jsx("div",{className:"p-4 pb-2",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("p",{className:"text-small font-medium",children:"在线客户"}),s.jsx(E,{content:"0",color:"primary",size:"sm",children:s.jsx(q,{icon:"solar:users-group-two-rounded-linear",width:16})})]})}),s.jsx(T,{className:"flex-1 px-4",children:s.jsx("div",{className:"space-y-2",children:!i&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[s.jsx(q,{className:"text-default-300 mb-4",icon:"solar:users-group-rounded-line-duotone",width:48}),s.jsx("p",{className:"text-small text-default-400 mb-2",children:"暂无在线客户"}),s.jsx("p",{className:"text-tiny text-default-300",children:"等待客户接入..."})]})})})]}),s.jsx("div",{className:"p-4 border-t border-divider",children:s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-large font-semibold text-primary",children:"0"}),s.jsx("p",{className:"text-tiny text-default-400",children:"今日接待"})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-large font-semibold text-success",children:"-"}),s.jsx("p",{className:"text-tiny text-default-400",children:"满意度"})]})]})})]}),s.jsxs("div",{className:"flex-1 flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-divider bg-content1",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[N&&s.jsx(d,{isIconOnly:!0,size:"sm",variant:"light",onClick:()=>y(!0),children:s.jsx(q,{icon:"solar:hamburger-menu-line-duotone",width:20})}),s.jsx(c,{size:"sm",src:i?.avatar||"https://nextuipro.nyc3.cdn.digitaloceanspaces.com/components-images/avatars/e1b8ec120710c09589a12c0004f85421.jpg",name:i?.name||"选择客户"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-small font-medium",children:i?.name||"选择客户"}),s.jsx("p",{className:"text-tiny text-default-500",children:i?"online"===i.status?"在线":"离线":"请从左侧选择客户开始对话"})]})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsx(d,{size:"sm",variant:"light",startContent:s.jsx(q,{icon:"solar:settings-linear",width:20}),onClick:()=>{k(!0)},children:"设置"})})]}),s.jsx(T,{className:"flex-1 p-6 space-y-4",children:i?s.jsxs(s.Fragment,{children:["connected"!==f&&s.jsx(G,{messageType:V,message:"connecting"===f?"正在连接服务器...":"连接已断开，正在重连..."}),(h[i.id]||[]).map(e=>"react_component"===e.type&&e.reactComponentData?s.jsx("div",{className:"mb-4",children:s.jsx(G,{avatar:e.senderAvatar,name:e.senderName,time:new Date(e.timestamp).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),message:"",messageType:F,isRTL:e.senderId===A?.id,status:e.status,classNames:{base:e.senderId===A?.id?"bg-primary-50":"bg-default-50"}})},e.id):s.jsx(G,{avatar:e.senderAvatar,name:e.senderName,time:new Date(e.timestamp).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),message:e.content,messageType:e.type,isRTL:e.senderId===A?.id,imageUrl:e.imageUrl,fileName:e.fileName,fileSize:e.fileSize,fileUrl:e.fileUrl,voiceDuration:e.voiceDuration,voiceUrl:e.voiceUrl,status:e.status,classNames:{base:e.senderId===A?.id?"bg-primary-50":"bg-default-50"}},e.id))]}):s.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[s.jsx(q,{className:"text-default-300 mb-4",icon:"solar:chat-round-line-duotone",width:80}),s.jsx("h3",{className:"text-large font-medium mb-2",children:"欢迎使用客服工作台"}),s.jsx("p",{className:"text-default-500 mb-4",children:"请从左侧客户列表中选择一个客户开始对话"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(l,{size:"sm",variant:"flat",color:"default",startContent:s.jsx(q,{icon:"solar:users-group-rounded-line-duotone",width:16}),children:"0 名客户在线"}),s.jsx(l,{size:"sm",variant:"flat",color:"success",startContent:s.jsx(q,{icon:"solar:check-circle-line-duotone",width:16}),children:"系统正常"})]})]})}),s.jsxs("div",{className:"p-4 border-t border-divider bg-content1",children:[Y.quickReplies.length>0&&s.jsx("div",{className:"mb-3",children:s.jsxs("div",{className:"flex flex-wrap gap-2",children:[Y.quickReplies.slice(0,3).map((e,t)=>s.jsx(d,{size:"sm",variant:"bordered",className:"text-tiny",onClick:()=>{e.trim()&&me({type:"text",content:e})},children:e.length>20?`${e.substring(0,20)}...`:e},`quick-reply-${e.substring(0,10)}-${t}`)),Y.quickReplies.length>3&&s.jsxs(O,{children:[s.jsx(U,{children:s.jsx(d,{size:"sm",variant:"light",children:s.jsx(q,{icon:"solar:menu-dots-line-duotone",width:16})})}),s.jsx(R,{children:Y.quickReplies.slice(3).map((e,t)=>s.jsx(z,{onClick:()=>{e.trim()&&me({type:"text",content:e})},children:e.length>30?`${e.substring(0,30)}...`:e},`settings-reply-${e.substring(0,10)}-${t+3}`))})]})]})}),s.jsx(X,{onSendMessage:me,onTyping:()=>{u&&u.sendTyping()},placeholder:"输入消息...",classNames:{button:"bg-primary opacity-100 w-[30px] h-[30px] !min-w-[30px] self-center",buttonIcon:"text-primary-foreground",input:"placeholder:text-default-500"}}),s.jsx("p",{className:"text-center text-tiny text-default-400 mt-2",children:"支持发送文字、图片、文件和语音消息"})]})]}),s.jsx(w,{isOpen:S,onClose:ue,size:"md",children:s.jsxs(a,{children:[s.jsx(j,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(q,{icon:"solar:settings-line-duotone",width:20}),s.jsx("span",{children:"客服设置"})]})}),s.jsx(r,{children:s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"text-small font-medium mb-3",children:"通知设置"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-small",children:"声音通知"}),s.jsx("p",{className:"text-tiny text-default-500",children:"新消息时播放提示音"})]}),s.jsx($,{size:"sm",isSelected:Y.soundNotifications,onValueChange:e=>pe("soundNotifications",e)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-small",children:"正在输入指示器"}),s.jsx("p",{className:"text-tiny text-default-500",children:"显示客户正在输入状态"})]}),s.jsx($,{size:"sm",isSelected:Y.showTypingIndicator,onValueChange:e=>pe("showTypingIndicator",e)})]})]})]}),s.jsx(M,{}),s.jsxs("div",{children:[s.jsx("h4",{className:"text-small font-medium mb-3",children:"工作状态"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-small",children:"在线状态"}),s.jsx("p",{className:"text-tiny text-default-500",children:"设置为在线接收新客户"})]}),s.jsx($,{size:"sm",isSelected:Y.onlineStatus,onValueChange:e=>pe("onlineStatus",e)})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-small",children:"自动回复"}),s.jsx("p",{className:"text-tiny text-default-500",children:"启用预设的自动回复消息"})]}),s.jsx($,{size:"sm",isSelected:Y.autoReply,onValueChange:e=>pe("autoReply",e)})]})]})]}),s.jsx(M,{}),s.jsxs("div",{children:[s.jsx("h4",{className:"text-small font-medium mb-3",children:"提示语设置"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-small mb-2",children:"欢迎消息"}),s.jsx("p",{className:"text-tiny text-default-500 mb-2",children:"新客户接入时的自动欢迎语"}),s.jsx("textarea",{className:"w-full p-2 text-small rounded-lg border border-divider bg-content2 resize-none",rows:3,value:Y.welcomeMessage,onChange:e=>pe("welcomeMessage",e.target.value),placeholder:"输入欢迎消息..."})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-small mb-2",children:"快捷回复"}),s.jsx("p",{className:"text-tiny text-default-500 mb-2",children:"设置常用的回复语句"}),s.jsxs("div",{className:"space-y-2",children:[Y.quickReplies.map((e,t)=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"text",className:"flex-1 p-2 text-small rounded-lg border border-divider bg-content2",value:e,onChange:e=>{const s=[...Y.quickReplies];s[t]=e.target.value,pe("quickReplies",s)},placeholder:`快捷回复 ${t+1}`}),s.jsx(d,{isIconOnly:!0,size:"sm",variant:"light",color:"danger",onClick:()=>{const e=Y.quickReplies.filter((e,s)=>s!==t);pe("quickReplies",e)},children:s.jsx(q,{icon:"solar:trash-bin-minimalistic-line-duotone",width:16})})]},`quick-reply-${e.substring(0,10)}-${t}`)),Y.quickReplies.length<10&&s.jsx(d,{size:"sm",variant:"bordered",startContent:s.jsx(q,{icon:"solar:add-circle-line-duotone",width:16}),onClick:()=>{const e=[...Y.quickReplies,""];pe("quickReplies",e)},className:"w-full",children:"添加快捷回复"})]})]})]})]}),s.jsx(M,{}),s.jsxs("div",{children:[s.jsx("h4",{className:"text-small font-medium mb-3",children:"系统信息"}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-small text-default-500",children:"客服工号"}),s.jsx("span",{className:"text-small",children:A?.id})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-small text-default-500",children:"连接状态"}),s.jsx(l,{size:"sm",variant:"flat",color:"connected"===f?"success":"warning",children:"connected"===f?"已连接":"未连接"})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-small text-default-500",children:"今日接待"}),s.jsx("span",{className:"text-small",children:"0 人"})]})]})]}),s.jsx(M,{})]})}),s.jsxs(v,{children:[s.jsx(d,{variant:"light",onPress:ue,children:"关闭"}),s.jsx(d,{color:"primary",onPress:ue,children:"保存"}),s.jsx(d,{color:"danger",variant:"light",onPress:async()=>{try{const e="http://localhost:6006";await fetch(`${e}/api/kefu/logout?kefu_id=${A?.id}`,{method:"POST"})}catch(e){}localStorage.removeItem("kefu_user"),localStorage.removeItem("kefu_session_token"),localStorage.removeItem("kefu_remember"),sessionStorage.removeItem("kefu_user"),sessionStorage.removeItem("kefu_session_token"),u&&(u.disconnect(),p(null)),W(null),P(!1),n([]),o(null),m({}),k(!1),x("disconnected"),setTimeout(()=>{window.location.href="/kefu/"},100)},startContent:s.jsx(q,{icon:"solar:logout-linear"}),children:"退出登录"})]})]})})]}):s.jsx(ne,{onLoginSuccess:fe})}new class{constructor(){this.config=this.loadConfig(),this.listeners=new Set}loadConfig(){try{const e=localStorage.getItem("adaptiveConfig");return e?{...me,...JSON.parse(e)}:me}catch(e){return me}}saveConfig(e){try{return this.config={...this.config,...e},localStorage.setItem("adaptiveConfig",JSON.stringify(this.config)),this.notifyListeners(),!0}catch(t){return!1}}getConfig(){return{...this.config}}updateConfig(e){return this.saveConfig(e)}resetConfig(){return this.saveConfig(me)}getAdaptiveModes(){return ue}getContainerTypes(){return pe}generateAdaptiveStyles(e,t={}){const s={...this.config,...t},n=[];n.push(`.adaptive-container-${e} {`),s.minWidth&&n.push(`  min-width: ${s.minWidth}px;`),s.maxWidth&&n.push(`  max-width: ${s.maxWidth}px;`),s.minHeight&&n.push(`  min-height: ${s.minHeight}px;`),s.maxHeight&&n.push(`  max-height: ${s.maxHeight}px;`);const i=ue[s.mode];i&&Object.entries(i.css).forEach(([e,t])=>{n.push(`  ${e}: ${t};`)});const a=pe[s.containerType];return a&&Object.entries(a.css).forEach(([e,t])=>{n.push(`  ${e}: ${t};`)}),s.customClasses&&s.customClasses.forEach(e=>{n.push(`  /* 自定义类: ${e} */`)}),n.push("}"),s.breakpoints&&Object.entries(s.breakpoints).forEach(([t,s])=>{n.push(`@media (max-width: ${t}px) {`),n.push(`  .adaptive-container-${e} {`),"object"==typeof s&&Object.entries(s).forEach(([e,t])=>{n.push(`    ${e}: ${t};`)}),n.push("  }"),n.push("}")}),n.join("\n")}calculateOptimalSize(e,t,s,n){const i=this.config;let a=s,r=n;switch(i.mode){case"fit":const i=e/s,o=t/n,c=Math.min(i,o,1);a=s*c,r=n*c;break;case"scroll":a=Math.min(s,e),r=Math.min(n,t);break;case"scale":a=e,r=t;break;default:a=Math.min(s,e),r=n*a/s}return i.minWidth&&(a=Math.max(a,i.minWidth)),i.maxWidth&&(a=Math.min(a,i.maxWidth)),i.minHeight&&(r=Math.max(r,i.minHeight)),i.maxHeight&&(r=Math.min(r,i.maxHeight)),{width:a,height:r}}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.config)}catch(t){}})}validateConfig(e){const t=[];return e.minWidth&&e.maxWidth&&e.minWidth>e.maxWidth&&t.push("最小宽度不能大于最大宽度"),e.minHeight&&e.maxHeight&&e.minHeight>e.maxHeight&&t.push("最小高度不能大于最大高度"),e.mode&&!ue[e.mode]&&t.push(`无效的自适应模式: ${e.mode}`),e.containerType&&!pe[e.containerType]&&t.push(`无效的容器类型: ${e.containerType}`),e.breakpoints&&Object.entries(e.breakpoints).forEach(([e,s])=>{const n=parseInt(e);(isNaN(n)||n<=0)&&t.push(`无效的断点: ${e}`)}),{isValid:0===t.length,errors:t}}exportConfig(){return{config:this.config,modes:ue,containerTypes:pe,timestamp:(new Date).toISOString()}}importConfig(e){try{if(e.config){return!!this.validateConfig(e.config).isValid&&this.saveConfig(e.config)}return!1}catch(t){return!1}}},H.createRoot(document.getElementById("root")).render(s.jsx(e.StrictMode,{children:s.jsx(D,{children:s.jsx(fe,{})})}));
