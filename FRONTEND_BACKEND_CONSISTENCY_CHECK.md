# å‰ç«¯ä¸åç«¯ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š

## ğŸ¯ æ£€æŸ¥æ¦‚è¿°

æœ¬æŠ¥å‘Šå¯¹ä¼ä¸šçº§å®¢æœç³»ç»Ÿçš„å‰ç«¯ä¸åç«¯è¿›è¡Œå…¨é¢çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼ŒåŒ…æ‹¬åŠŸèƒ½ã€ç»„ä»¶ã€å‚æ•°å’ŒAPIæ¥å£çš„æ¯”å¯¹åˆ†æã€‚

## ğŸ“Š æ£€æŸ¥èŒƒå›´

### å‰ç«¯é¡¹ç›®
- **å®¢æˆ·ç«¯**: `static/react-kehu/` (React + TypeScript)
- **å®¢æœç«¯**: `static/react-kefu/` (React + JavaScript)

### åç«¯é¡¹ç›®
- **APIè·¯ç”±**: `src/routes/`
- **å¤„ç†å™¨**: `src/handlers/`
- **WebSocket**: `src/websocket.rs`
- **è®¤è¯**: `src/auth/`

## ğŸ” ç¬¬ä¸€æ­¥ï¼šåŠŸèƒ½/ç»„ä»¶/å‚æ•°ä¸€è‡´æ€§æ£€æŸ¥

### 1. APIç«¯ç‚¹ä¸€è‡´æ€§æ£€æŸ¥

#### 1.1 è®¤è¯ç›¸å…³API

| å‰ç«¯ç«¯ç‚¹ | åç«¯ç«¯ç‚¹ | çŠ¶æ€ | é—®é¢˜æè¿° |
|----------|----------|------|----------|
| `/api/auth/login` | `/auth/login` | âŒ **ä¸ä¸€è‡´** | å‰ç«¯ä½¿ç”¨`/api/auth/login`ï¼Œåç«¯ä½¿ç”¨`/auth/login` |
| `/api/auth/logout` | `/auth/logout` | âŒ **ä¸ä¸€è‡´** | å‰ç«¯ä½¿ç”¨`/api/auth/login`ï¼Œåç«¯ä½¿ç”¨`/auth/logout` |
| `/api/auth/validate` | `/auth/validate` | âŒ **ä¸ä¸€è‡´** | å‰ç«¯ä½¿ç”¨`/api/auth/validate`ï¼Œåç«¯ä½¿ç”¨`/auth/validate` |

#### 1.2 ç”¨æˆ·ç›¸å…³API

| å‰ç«¯ç«¯ç‚¹ | åç«¯ç«¯ç‚¹ | çŠ¶æ€ | é—®é¢˜æè¿° |
|----------|----------|------|----------|
| `/api/users/online` | `/api/users/online` | âœ… **ä¸€è‡´** | åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ |
| `/api/user/info` | æœªæ‰¾åˆ° | âŒ **ç¼ºå¤±** | åç«¯ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯API |
| `/api/user/status` | æœªæ‰¾åˆ° | âŒ **ç¼ºå¤±** | åç«¯ç¼ºå°‘ç”¨æˆ·çŠ¶æ€æ›´æ–°API |

#### 1.3 æ¶ˆæ¯ç›¸å…³API

| å‰ç«¯ç«¯ç‚¹ | åç«¯ç«¯ç‚¹ | çŠ¶æ€ | é—®é¢˜æè¿° |
|----------|----------|------|----------|
| `/api/messages/{userId}` | æœªæ‰¾åˆ° | âŒ **ç¼ºå¤±** | åç«¯ç¼ºå°‘è·å–æ¶ˆæ¯å†å²API |
| `/api/messages` | æœªæ‰¾åˆ° | âŒ **ç¼ºå¤±** | åç«¯ç¼ºå°‘æ¶ˆæ¯åˆ—è¡¨API |

#### 1.4 æ–‡ä»¶ç›¸å…³API

| å‰ç«¯ç«¯ç‚¹ | åç«¯ç«¯ç‚¹ | çŠ¶æ€ | é—®é¢˜æè¿° |
|----------|----------|------|----------|
| `/api/file/upload` | `/api/file/upload` | âœ… **ä¸€è‡´** | æ–‡ä»¶ä¸Šä¼  |
| `/api/upload` | æœªæ‰¾åˆ° | âŒ **ç¼ºå¤±** | å‰ç«¯ä½¿ç”¨`/api/upload`ï¼Œåç«¯ä½¿ç”¨`/api/file/upload` |

### 2. æ•°æ®ç»“æ„ä¸€è‡´æ€§æ£€æŸ¥

#### 2.1 ç”¨æˆ·æ•°æ®ç»“æ„

**å‰ç«¯å®šä¹‰** (`static/react-kehu/services/enterprise-adapter.ts`):
```typescript
export interface User {
  id: string;
  name: string;
  role: 'customer' | 'support';
  avatar?: string;
  status: 'online' | 'offline';
}
```

**åç«¯å®šä¹‰** (`src/auth/kefu_auth.rs`):
```rust
pub struct KefuAuth {
    pub kefu_id: String,
    pub username: String,
    pub password_hash: String,
    pub real_name: String,
    pub department: String,
    pub is_active: bool,
    pub max_customers: u32,
}
```

**ä¸€è‡´æ€§åˆ†æ**:
- âŒ **å­—æ®µä¸åŒ¹é…**: å‰ç«¯ä½¿ç”¨`id/name/role/status`ï¼Œåç«¯ä½¿ç”¨`kefu_id/username/real_name/is_active`
- âŒ **ç±»å‹ä¸åŒ¹é…**: å‰ç«¯`role`ä¸ºæšä¸¾ï¼Œåç«¯æ— å¯¹åº”å­—æ®µ
- âŒ **çŠ¶æ€å­—æ®µ**: å‰ç«¯ä½¿ç”¨`status`ï¼Œåç«¯ä½¿ç”¨`is_active`

#### 2.2 æ¶ˆæ¯æ•°æ®ç»“æ„

**å‰ç«¯å®šä¹‰**:
```typescript
export interface Message {
  id: string;
  senderId: string;
  receiverId: string;
  text: string;
  type: 'text' | 'file' | 'voice';
  time: string;
  status: 'sending' | 'sent' | 'read' | 'error';
  fileUrl?: string;
  fileName?: string;
}
```

**åç«¯å®šä¹‰** (`src/message.rs`):
```rust
pub struct Message {
    pub id: String,
    pub from: String,
    pub to: String,
    pub content: String,
    pub message_type: MessageType,
    pub timestamp: DateTime<Utc>,
    pub status: MessageStatus,
}
```

**ä¸€è‡´æ€§åˆ†æ**:
- âŒ **å­—æ®µåä¸åŒ¹é…**: å‰ç«¯ä½¿ç”¨`senderId/receiverId`ï¼Œåç«¯ä½¿ç”¨`from/to`
- âŒ **å†…å®¹å­—æ®µ**: å‰ç«¯ä½¿ç”¨`text`ï¼Œåç«¯ä½¿ç”¨`content`
- âŒ **æ—¶é—´å­—æ®µ**: å‰ç«¯ä½¿ç”¨`time`ï¼Œåç«¯ä½¿ç”¨`timestamp`
- âŒ **ç±»å‹å­—æ®µ**: å‰ç«¯ä½¿ç”¨`type`ï¼Œåç«¯ä½¿ç”¨`message_type`

#### 2.3 ç™»å½•è¯·æ±‚æ•°æ®ç»“æ„

**å‰ç«¯å‘é€**:
```typescript
{
  username: string;
  password: string;
  role: string;
}
```

**åç«¯æ¥æ”¶** (`src/user_manager.rs`):
```rust
pub struct LoginRequest {
    pub username: String,
    pub password: String,
}
```

**ä¸€è‡´æ€§åˆ†æ**:
- âŒ **å­—æ®µä¸åŒ¹é…**: å‰ç«¯å‘é€`role`å­—æ®µï¼Œåç«¯æœªå®šä¹‰
- âœ… **åŸºç¡€å­—æ®µ**: `username/password`å­—æ®µä¸€è‡´

### 3. WebSocketå‚æ•°ä¸€è‡´æ€§æ£€æŸ¥

#### 3.1 è¿æ¥å‚æ•°

**å‰ç«¯å‘é€** (`static/react-kefu/src/websocket-client.js`):
```javascript
const params = new URLSearchParams({
  user_id: this.userId,
  user_type: this.userType,
  user_name: this.userId,
  session_id: `session_${Date.now()}`,
  timestamp: new Date().toISOString()
});

if (this.userType === 'kefu' && this.sessionToken) {
  params.set('session_token', this.sessionToken);
}
```

**åç«¯æ¥æ”¶** (`src/types/websocket.rs`):
```rust
pub struct WebSocketParams {
    pub user_id: String,
    pub user_type: String,
    pub user_name: String,
    pub session_id: Option<String>,
    pub session_token: Option<String>,
}
```

**ä¸€è‡´æ€§åˆ†æ**:
- âœ… **åŸºç¡€å‚æ•°**: `user_id/user_type/user_name`ä¸€è‡´
- âœ… **ä¼šè¯å‚æ•°**: `session_id/session_token`ä¸€è‡´
- âŒ **é¢å¤–å‚æ•°**: å‰ç«¯å‘é€`timestamp`ï¼Œåç«¯æœªå®šä¹‰

### 4. é…ç½®å‚æ•°ä¸€è‡´æ€§æ£€æŸ¥

#### 4.1 APIé…ç½®

**å‰ç«¯é…ç½®** (`static/react-kefu/src/api-config.js`):
```javascript
export const API_CONFIG = {
    WS_URL: 'ws://localhost:6006/ws',
    API_BASE_URL: 'http://localhost:6006',
    UPLOAD: {
      MAX_FILE_SIZE: 10,
      MAX_IMAGE_SIZE: 5,
      MAX_VOICE_DURATION: 60,
    },
    TIMEOUT: {
      DEFAULT: 10000,
      UPLOAD: 30000,
    },
};
```

**åç«¯é…ç½®** (`config/app-config.json`):
```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 6006
  },
  "frontend": {
    "upload": {
      "maxFileSize": 10485760
    }
  }
}
```

**ä¸€è‡´æ€§åˆ†æ**:
- âœ… **ç«¯å£é…ç½®**: å‰ç«¯6006ï¼Œåç«¯6006ï¼Œä¸€è‡´
- âŒ **æ–‡ä»¶å¤§å°**: å‰ç«¯10MBï¼Œåç«¯10MBï¼Œä½†å•ä½ä¸åŒ
- âŒ **è¶…æ—¶é…ç½®**: å‰ç«¯æœ‰è¶…æ—¶é…ç½®ï¼Œåç«¯æœªå®šä¹‰

## ğŸ” ç¬¬äºŒæ­¥ï¼šAPIæ¥å£å¯ç”¨æ€§æ£€æŸ¥

### 1. ç¼ºå¤±çš„APIæ¥å£

#### 1.1 è®¤è¯APIè·¯å¾„ä¸åŒ¹é…
- **é—®é¢˜**: å‰ç«¯ä½¿ç”¨`/api/auth/*`ï¼Œåç«¯ä½¿ç”¨`/auth/*`
- **å½±å“**: è®¤è¯åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œ
- **è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹å‰ç«¯æˆ–åç«¯è·¯å¾„

#### 1.2 ç¼ºå¤±çš„ç”¨æˆ·ä¿¡æ¯API
- **é—®é¢˜**: å‰ç«¯è°ƒç”¨`/api/user/info`ï¼Œåç«¯æœªå®ç°
- **å½±å“**: ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºåŠŸèƒ½å¼‚å¸¸
- **è§£å†³æ–¹æ¡ˆ**: åœ¨åç«¯å®ç°ç”¨æˆ·ä¿¡æ¯API

#### 1.3 ç¼ºå¤±çš„æ¶ˆæ¯å†å²API
- **é—®é¢˜**: å‰ç«¯è°ƒç”¨`/api/messages/{userId}`ï¼Œåç«¯æœªå®ç°
- **å½±å“**: æ¶ˆæ¯å†å²è®°å½•åŠŸèƒ½å¼‚å¸¸
- **è§£å†³æ–¹æ¡ˆ**: åœ¨åç«¯å®ç°æ¶ˆæ¯å†å²API

#### 1.4 æ–‡ä»¶ä¸Šä¼ è·¯å¾„ä¸åŒ¹é…
- **é—®é¢˜**: å‰ç«¯ä½¿ç”¨`/api/upload`ï¼Œåç«¯ä½¿ç”¨`/api/file/upload`
- **å½±å“**: æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å¼‚å¸¸
- **è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€æ–‡ä»¶ä¸Šä¼ è·¯å¾„

### 2. æ•°æ®ç»“æ„ä¸åŒ¹é…é—®é¢˜

#### 2.1 ç”¨æˆ·æ•°æ®ç»“æ„ä¸åŒ¹é…
- **é—®é¢˜**: å‰åç«¯ç”¨æˆ·å­—æ®µå®šä¹‰ä¸ä¸€è‡´
- **å½±å“**: ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºå’Œæ›´æ–°å¼‚å¸¸
- **è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ç”¨æˆ·æ•°æ®ç»“æ„

#### 2.2 æ¶ˆæ¯æ•°æ®ç»“æ„ä¸åŒ¹é…
- **é—®é¢˜**: å‰åç«¯æ¶ˆæ¯å­—æ®µå®šä¹‰ä¸ä¸€è‡´
- **å½±å“**: æ¶ˆæ¯å‘é€å’Œæ˜¾ç¤ºå¼‚å¸¸
- **è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€æ¶ˆæ¯æ•°æ®ç»“æ„

#### 2.3 ç™»å½•è¯·æ±‚ç»“æ„ä¸åŒ¹é…
- **é—®é¢˜**: å‰ç«¯å‘é€roleå­—æ®µï¼Œåç«¯æœªå®šä¹‰
- **å½±å“**: ç™»å½•åŠŸèƒ½å¯èƒ½å¼‚å¸¸
- **è§£å†³æ–¹æ¡ˆ**: åœ¨åç«¯æ·»åŠ roleå­—æ®µæˆ–å‰ç«¯ç§»é™¤

## ğŸ› ï¸ ä¿®å¤å»ºè®®

### 1. ç«‹å³ä¿®å¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1.1 ç»Ÿä¸€APIè·¯å¾„
```rust
// åç«¯ä¿®æ”¹ï¼šå°†è®¤è¯è·¯ç”±æ”¹ä¸º/api/auth/*
pub fn build_auth_routes() -> impl Filter<...> {
    let login_route = warp::path!("api" / "auth" / "login")
        .and(warp::post())
        // ...
}
```

#### 1.2 å®ç°ç¼ºå¤±çš„API
```rust
// åç«¯æ·»åŠ ï¼šç”¨æˆ·ä¿¡æ¯API
let user_info_route = warp::path!("api" / "user" / "info")
    .and(warp::get())
    .and_then(|| async {
        // å®ç°ç”¨æˆ·ä¿¡æ¯è·å–é€»è¾‘
    });

// åç«¯æ·»åŠ ï¼šæ¶ˆæ¯å†å²API
let messages_route = warp::path!("api" / "messages" / String)
    .and(warp::get())
    .and_then(|user_id: String| async move {
        // å®ç°æ¶ˆæ¯å†å²è·å–é€»è¾‘
    });
```

#### 1.3 ç»Ÿä¸€æ•°æ®ç»“æ„
```rust
// åç«¯ä¿®æ”¹ï¼šç»Ÿä¸€ç”¨æˆ·æ•°æ®ç»“æ„
pub struct User {
    pub id: String,
    pub name: String,
    pub role: UserRole,
    pub avatar: Option<String>,
    pub status: UserStatus,
}

// åç«¯ä¿®æ”¹ï¼šç»Ÿä¸€æ¶ˆæ¯æ•°æ®ç»“æ„
pub struct Message {
    pub id: String,
    pub sender_id: String,
    pub receiver_id: String,
    pub text: String,
    pub message_type: MessageType,
    pub time: DateTime<Utc>,
    pub status: MessageStatus,
}
```

### 2. ä¸­æœŸä¿®å¤ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 2.1 å®Œå–„é…ç½®ç³»ç»Ÿ
- ç»Ÿä¸€å‰åç«¯é…ç½®å‚æ•°
- æ·»åŠ é…ç½®éªŒè¯æœºåˆ¶
- å®ç°é…ç½®çƒ­æ›´æ–°

#### 2.2 å¢å¼ºé”™è¯¯å¤„ç†
- ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- å®ç°é”™è¯¯æ—¥å¿—è®°å½•

### 3. é•¿æœŸä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

#### 3.1 æ€§èƒ½ä¼˜åŒ–
- å®ç°APIç¼“å­˜æœºåˆ¶
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- æ·»åŠ æ€§èƒ½ç›‘æ§

#### 3.2 å®‰å…¨æ€§å¢å¼º
- å®ç°APIè®¿é—®æ§åˆ¶
- æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
- å¢å¼ºæ•°æ®éªŒè¯

## ğŸ“Š ä¿®å¤ä¼˜å…ˆçº§çŸ©é˜µ

| é—®é¢˜ç±»å‹ | å½±å“ç¨‹åº¦ | ä¿®å¤éš¾åº¦ | ä¼˜å…ˆçº§ |
|----------|----------|----------|--------|
| APIè·¯å¾„ä¸åŒ¹é… | é«˜ | ä½ | ğŸ”´ ç«‹å³ |
| æ•°æ®ç»“æ„ä¸åŒ¹é… | é«˜ | ä¸­ | ğŸ”´ ç«‹å³ |
| ç¼ºå¤±APIæ¥å£ | é«˜ | ä¸­ | ğŸŸ¡ é«˜ |
| é…ç½®ä¸ä¸€è‡´ | ä¸­ | ä½ | ğŸŸ¡ é«˜ |
| é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€ | ä¸­ | ä¸­ | ğŸŸ¢ ä¸­ |
| æ€§èƒ½ä¼˜åŒ– | ä½ | é«˜ | ğŸŸ¢ ä½ |

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µ1ï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰
1. ä¿®å¤APIè·¯å¾„ä¸åŒ¹é…é—®é¢˜
2. å®ç°ç¼ºå¤±çš„æ ¸å¿ƒAPIæ¥å£
3. ç»Ÿä¸€åŸºç¡€æ•°æ®ç»“æ„

### é˜¶æ®µ2ï¼šåŠŸèƒ½å®Œå–„ï¼ˆ3-5å¤©ï¼‰
1. å®Œå–„æ‰€æœ‰APIæ¥å£å®ç°
2. ç»Ÿä¸€é…ç½®ç³»ç»Ÿ
3. å¢å¼ºé”™è¯¯å¤„ç†

### é˜¶æ®µ3ï¼šä¼˜åŒ–æå‡ï¼ˆ1å‘¨ï¼‰
1. æ€§èƒ½ä¼˜åŒ–
2. å®‰å…¨æ€§å¢å¼º
3. ç›‘æ§å’Œæ—¥å¿—å®Œå–„

## ğŸ“‹ æ£€æŸ¥æ€»ç»“

### å‘ç°çš„é—®é¢˜
- **APIè·¯å¾„ä¸åŒ¹é…**: 5ä¸ª
- **æ•°æ®ç»“æ„ä¸ä¸€è‡´**: 3ä¸ª
- **ç¼ºå¤±APIæ¥å£**: 4ä¸ª
- **é…ç½®ä¸ä¸€è‡´**: 2ä¸ª

### å½±å“è¯„ä¼°
- **åŠŸèƒ½å¼‚å¸¸**: è®¤è¯ã€æ¶ˆæ¯ã€æ–‡ä»¶ä¸Šä¼ ç­‰æ ¸å¿ƒåŠŸèƒ½å—å½±å“
- **ç”¨æˆ·ä½“éªŒ**: ç•Œé¢æ˜¾ç¤ºå¼‚å¸¸ï¼Œæ“ä½œå¤±è´¥
- **ç³»ç»Ÿç¨³å®šæ€§**: å¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–æ•°æ®ä¸¢å¤±

### å»ºè®®
1. **ç«‹å³å¼€å§‹ä¿®å¤**: ä¼˜å…ˆä¿®å¤é«˜ä¼˜å…ˆçº§é—®é¢˜
2. **åˆ†é˜¶æ®µå®æ–½**: æŒ‰ç…§ä¼˜å…ˆçº§çŸ©é˜µé€æ­¥ä¿®å¤
3. **å……åˆ†æµ‹è¯•**: æ¯ä¸ªä¿®å¤åè¿›è¡Œå®Œæ•´æµ‹è¯•
4. **æ–‡æ¡£æ›´æ–°**: åŒæ­¥æ›´æ–°APIæ–‡æ¡£å’Œå¼€å‘æ–‡æ¡£

**ç»“è®º**: å‰ç«¯ä¸åç«¯å­˜åœ¨è¾ƒå¤šä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦ç³»ç»Ÿæ€§çš„ä¿®å¤å·¥ä½œã€‚å»ºè®®ç«‹å³å¼€å§‹é«˜ä¼˜å…ˆçº§é—®é¢˜çš„ä¿®å¤ï¼Œç¡®ä¿ç³»ç»ŸåŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚