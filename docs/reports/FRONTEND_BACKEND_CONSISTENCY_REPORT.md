# å‰åç«¯APIä¸€è‡´æ€§åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ä¼ä¸šçº§å®¢æœç³»ç»Ÿçš„å‰åç«¯APIè¿›è¡Œäº†å…¨é¢çš„ä¸€è‡´æ€§åˆ†æï¼Œå‘ç°äº†å¤šä¸ªéœ€è¦ä¿®å¤çš„ä¸ä¸€è‡´é—®é¢˜ã€‚

## ä¸€ã€å…³é”®ä¸ä¸€è‡´é—®é¢˜

### 1. è®¤è¯æ¥å£ä¸ä¸€è‡´

| æ¥å£ | å‰ç«¯æœŸæœ› | åç«¯å®é™… | ä¸¥é‡ç¨‹åº¦ |
|------|---------|----------|----------|
| å®¢æœç™»å½• | POST `/api/kefu/login` | âœ… åŒ¹é… | - |
| å®¢æˆ·ç™»å½• | POST `/auth/login` | POST `/auth/login` | âš ï¸ ä¸­ |

**é—®é¢˜è¯¦æƒ…**ï¼š
- kehu-react ä½¿ç”¨ `/auth/login`ï¼ŒæœŸæœ›å‚æ•°åŒ…å« `user_type: 'Kehu' | 'Kefu'`
- åç«¯çš„ `/auth/login` ä¸å¤„ç† `user_type` å‚æ•°
- åç«¯è¿”å›æ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸å®Œå…¨åŒ¹é…

### 2. WebSocket è¿æ¥å‚æ•°

| å‚æ•° | å‰ç«¯å‘é€ | åç«¯æœŸæœ› | çŠ¶æ€ |
|------|---------|----------|------|
| user_id | âœ… user_id | user_id æˆ– id | âœ… |
| user_type | âœ… user_type | user_type æˆ– type | âœ… |
| session_token | âœ… session_token (kefu) | âœ… æŸ¥è¯¢å‚æ•° | âœ… |
| user_name | âœ… user_name | user_name æˆ– name | âœ… |

**æ³¨æ„äº‹é¡¹**ï¼š
- åç«¯æ¥å—å¤šç§å‚æ•°åˆ«åï¼Œå‰ç«¯ä½¿ç”¨çš„æ˜¯æ ‡å‡†åç§°
- åç«¯æ”¯æŒä¸­æ–‡å‚æ•°å€¼ï¼ˆ"å®¢æœ"ã€"å®¢æˆ·"ï¼‰ï¼Œä½†å‰ç«¯ä½¿ç”¨è‹±æ–‡å€¼

### 3. æ–‡ä»¶ä¸Šä¼ æ¥å£

| åŠŸèƒ½ | å‰ç«¯è°ƒç”¨ | åç«¯å®ç° | çŠ¶æ€ |
|------|---------|----------|------|
| æ–‡ä»¶ä¸Šä¼  | POST `/api/file/upload` | âœ… å­˜åœ¨ | âœ… |
| å›¾ç‰‡ä¸Šä¼  | POST `/api/image/upload` | âŒ ä¸å­˜åœ¨ | âŒ |
| è¯­éŸ³ä¸Šä¼  | POST `/api/voice/upload` | âœ… å­˜åœ¨ | âœ… |

**é—®é¢˜**ï¼š
- å‰ç«¯æœŸæœ›ç‹¬ç«‹çš„å›¾ç‰‡ä¸Šä¼ æ¥å£ `/api/image/upload`
- åç«¯åªæä¾›ç»Ÿä¸€çš„æ–‡ä»¶ä¸Šä¼ æ¥å£
- éœ€è¦å‰ç«¯é€‚é…æˆ–åç«¯æ·»åŠ è·¯ç”±åˆ«å

### 4. æ¶ˆæ¯å‘é€æ¥å£

| æ¥å£ | å‰ç«¯æœŸæœ› | åç«¯å®é™… | ä¸¥é‡ç¨‹åº¦ |
|------|---------|----------|----------|
| å‘é€æ¶ˆæ¯ | POST `/api/message/send` | âŒ ä¸å­˜åœ¨ | ğŸ”´ é«˜ |
| è·å–æ¶ˆæ¯ | GET `/api/messages` | âœ… å­˜åœ¨ | âœ… |

**ä¸¥é‡é—®é¢˜**ï¼š
- å‰ç«¯æœŸæœ›é€šè¿‡ HTTP API å‘é€æ¶ˆæ¯
- åç«¯è®¾è®¡ä¸ºé€šè¿‡ WebSocket å‘é€æ‰€æœ‰æ¶ˆæ¯
- éœ€è¦ä¿®æ”¹å‰ç«¯é€»è¾‘ä½¿ç”¨ WebSocket

### 5. ç”¨æˆ·ç®¡ç†æ¥å£

| åŠŸèƒ½ | å‰ç«¯è°ƒç”¨ | åç«¯å®ç° | çŠ¶æ€ |
|------|---------|----------|------|
| è·å–ç”¨æˆ·ä¿¡æ¯ | GET `/api/user/info` | âŒ ä¸å­˜åœ¨ | âŒ |
| æ›´æ–°ç”¨æˆ·çŠ¶æ€ | POST `/api/user/status` | âŒ ä¸å­˜åœ¨ | âŒ |
| è·å–åœ¨çº¿ç”¨æˆ· | GET `/api/users/online` | âœ… å­˜åœ¨ | âœ… |

**é—®é¢˜**ï¼š
- å‰ç«¯æœŸæœ›çš„å•ä¸ªç”¨æˆ·æ¥å£ä¸å­˜åœ¨
- åç«¯æä¾›çš„æ˜¯æ‰¹é‡ç”¨æˆ·ç®¡ç†æ¥å£

## äºŒã€WebSocket æ¶ˆæ¯æ ¼å¼å¯¹æ¯”

### 1. Chat æ¶ˆæ¯

**å‰ç«¯å‘é€**ï¼š
```json
{
  "type": "Chat",
  "from": "user_id",
  "to": "receiver_id",
  "content": "message text",
  "content_type": "text",
  "from_user_id": "sender_id",
  "to_user_id": "receiver_id",
  "timestamp": "ISO8601"
}
```

**åç«¯æœŸæœ›**ï¼š
```json
{
  "type": "Chat",
  "from": "string",
  "to": "optional string",
  "content": "string",
  "content_type": "Text|Image|File|Voice|Video|Html",
  "timestamp": "ISO8601"
}
```

**ä¸ä¸€è‡´**ï¼š
- å‰ç«¯å‘é€é‡å¤çš„ `from_user_id` å’Œ `to_user_id`
- å‰ç«¯ä½¿ç”¨å°å†™ `text`ï¼Œåç«¯æœŸæœ›é¦–å­—æ¯å¤§å†™ `Text`

### 2. Heartbeat æ¶ˆæ¯

**çŠ¶æ€**ï¼šâœ… æ ¼å¼åŒ¹é…

### 3. Typing æ¶ˆæ¯

**å‰ç«¯å‘é€**ï¼š
```json
{
  "type": "Typing",
  "user_id": "string",
  "target_id": "string",
  "timestamp": "ISO8601"
}
```

**åç«¯æœŸæœ›**ï¼š
```json
{
  "type": "Typing",
  "from": "string",
  "to": "optional",
  "is_typing": true/false,
  "timestamp": "ISO8601"
}
```

**ä¸ä¸€è‡´**ï¼š
- å‚æ•°åç§°ä¸åŒï¼š`user_id` vs `from`ï¼Œ`target_id` vs `to`
- åç«¯æœŸæœ› `is_typing` å¸ƒå°”å€¼ï¼Œå‰ç«¯æœªå‘é€

## ä¸‰ã€éœ€è¦ä¿®å¤çš„é—®é¢˜æ¸…å•

### é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰

1. **æ¶ˆæ¯å‘é€æœºåˆ¶**
   - å‰ç«¯éœ€è¦ç§»é™¤ `/api/message/send` è°ƒç”¨
   - æ”¹ä¸ºä½¿ç”¨ WebSocket å‘é€æ‰€æœ‰æ¶ˆæ¯

2. **å›¾ç‰‡ä¸Šä¼ æ¥å£**
   - æ–¹æ¡ˆAï¼šå‰ç«¯ä¿®æ”¹ä¸ºä½¿ç”¨ `/api/file/upload`
   - æ–¹æ¡ˆBï¼šåç«¯æ·»åŠ  `/api/image/upload` è·¯ç”±åˆ«å

3. **Chat æ¶ˆæ¯æ ¼å¼**
   - å‰ç«¯ä¿®æ”¹ `content_type` å€¼ä¸ºé¦–å­—æ¯å¤§å†™
   - ç§»é™¤å†—ä½™çš„ `from_user_id` å’Œ `to_user_id`

4. **Typing æ¶ˆæ¯æ ¼å¼**
   - å‰ç«¯ä¿®æ”¹å‚æ•°åç§°åŒ¹é…åç«¯
   - æ·»åŠ  `is_typing` å¸ƒå°”å€¼

### ä¸­ä¼˜å…ˆçº§ï¼ˆå½±å“éƒ¨åˆ†åŠŸèƒ½ï¼‰

5. **ç”¨æˆ·ä¿¡æ¯æ¥å£**
   - å‰ç«¯é€‚é…ä½¿ç”¨ç°æœ‰çš„æ‰¹é‡æ¥å£
   - æˆ–åç«¯æ·»åŠ å•ç”¨æˆ·æŸ¥è¯¢æ¥å£

6. **å®¢æˆ·ç«¯è®¤è¯**
   - ç»Ÿä¸€è®¤è¯æµç¨‹å’Œå‚æ•°

### ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–å»ºè®®ï¼‰

7. **å‚æ•°å‘½åä¸€è‡´æ€§**
   - ç»Ÿä¸€ä½¿ç”¨ snake_case æˆ– camelCase
   - é¿å…ä¸­è‹±æ–‡æ··ç”¨

8. **é”™è¯¯å¤„ç†**
   - ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
   - æ·»åŠ é”™è¯¯ä»£ç ä½“ç³»

## å››ã€ä¿®å¤å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆPhase 1ï¼‰

1. **ä¿®æ”¹å‰ç«¯ Chat æ¶ˆæ¯æ ¼å¼**
```javascript
// ä¿®æ”¹å‰
{
  content_type: "text",
  from_user_id: userId,
  to_user_id: targetId
}

// ä¿®æ”¹å
{
  content_type: "Text", // é¦–å­—æ¯å¤§å†™
  from: userId,
  to: targetId
}
```

2. **ç»Ÿä¸€å›¾ç‰‡ä¸Šä¼ æ¥å£**
```javascript
// ä¿®æ”¹å‰
const uploadUrl = type === 'image' ? '/api/image/upload' : '/api/file/upload';

// ä¿®æ”¹å
const uploadUrl = '/api/file/upload'; // ç»Ÿä¸€ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ¥å£
```

3. **ä¿®å¤ Typing æ¶ˆæ¯**
```javascript
// ä¿®æ”¹å‰
{
  type: 'Typing',
  user_id: userId,
  target_id: targetId
}

// ä¿®æ”¹å
{
  type: 'Typing',
  from: userId,
  to: targetId,
  is_typing: true
}
```

### åç»­ä¼˜åŒ–ï¼ˆPhase 2ï¼‰

1. å®ç°ç¼ºå¤±çš„ä¾¿åˆ©æ¥å£
2. ç»Ÿä¸€å‚æ•°å‘½åè§„èŒƒ
3. å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶
4. æ·»åŠ  API ç‰ˆæœ¬æ§åˆ¶

## äº”ã€é£é™©è¯„ä¼°

| ä¿®å¤é¡¹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | å»ºè®® |
|--------|----------|----------|------|
| æ¶ˆæ¯æ ¼å¼ä¿®æ”¹ | ä½ | ä»…å‰ç«¯ | ç«‹å³ä¿®å¤ |
| å›¾ç‰‡ä¸Šä¼ ç»Ÿä¸€ | ä½ | ä»…å‰ç«¯ | ç«‹å³ä¿®å¤ |
| WebSocket å‚æ•° | ä¸­ | å‰åç«¯ | å……åˆ†æµ‹è¯• |
| è®¤è¯æµç¨‹ç»Ÿä¸€ | é«˜ | å…¨ç³»ç»Ÿ | è°¨æ…å¤„ç† |

## å…­ã€ç»“è®º

ç³»ç»Ÿå­˜åœ¨å¤šå¤„å‰åç«¯ä¸ä¸€è‡´é—®é¢˜ï¼Œä½†å¤§éƒ¨åˆ†å¯ä»¥é€šè¿‡ä¿®æ”¹å‰ç«¯ä»£ç è§£å†³ï¼Œé¿å…åç«¯é‡æ–°ç¼–è¯‘çš„é£é™©ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥ä¿®å¤ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œåå†è¿›è¡Œä¼˜åŒ–ã€‚